<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Manager</title>
    <style>
        /* Define theme variables locally for the popup */
        :root {
            --popup-primary-color: #007bff;
            --popup-primary-darker: #0056b3;
            --popup-secondary-color: #6c757d;
            --popup-secondary-darker: #5a6268;
            --popup-success-color: #28a745;
            --popup-success-darker: #1e7e34;
            --popup-danger-color: #dc3545;

            --popup-light-bg: #f8f9fa;
            --popup-light-card-bg: #ffffff;
            --popup-light-text: #212529;
            --popup-light-text-secondary: #6c757d;
            --popup-light-border: #dee2e6;
            --popup-light-input-bg: #ffffff;
            --popup-light-input-border: #ced4da;
            --popup-light-focus-shadow: rgba(0, 123, 255, 0.2);
            --popup-light-hover-bg: #e9ecef;
            --popup-light-item-hover: #f1f1f1;
            --popup-strength-bg: #f0f0f0;
            --popup-strength-border: #ddd;

            --popup-dark-bg: #212529;
            --popup-dark-card-bg: #343a40;
            --popup-dark-text: #f8f9fa;
            --popup-dark-text-secondary: #adb5bd;
            --popup-dark-border: #495057;
            --popup-dark-input-bg: #495057;
            --popup-dark-input-border: #6c757d;
            --popup-dark-focus-shadow: rgba(13, 110, 253, 0.3);
            --popup-dark-hover-bg: #495057;
            --popup-dark-item-hover: #454b51;
            --popup-strength-bg: #495057;
            --popup-strength-border: #6c757d;

            /* Default to light */
            --popup-bg: var(--popup-light-bg);
            --popup-card-bg: var(--popup-light-card-bg);
            --popup-text: var(--popup-light-text);
            --popup-text-secondary: var(--popup-light-text-secondary);
            --popup-border: var(--popup-light-border);
            --popup-input-bg: var(--popup-light-input-bg);
            --popup-input-border: var(--popup-light-input-border);
            --popup-focus-shadow: var(--popup-light-focus-shadow);
            --popup-hover-bg: var(--popup-light-hover-bg);
            --popup-item-hover: var(--popup-light-item-hover);
            --popup-hdr-bg: var(--popup-primary-color);
            --popup-hdr-text: white;
            --popup-strength-bg-color: var(--popup-strength-bg);
            --popup-strength-border-color: var(--popup-strength-border);


            --popup-border-radius: 4px;
            --popup-transition: 0.2s ease;
            --popup-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body[data-theme="dark"] {
            --popup-bg: var(--popup-dark-bg);
            --popup-card-bg: var(--popup-dark-card-bg);
            --popup-text: var(--popup-dark-text);
            --popup-text-secondary: var(--popup-dark-text-secondary);
            --popup-border: var(--popup-dark-border);
            --popup-input-bg: var(--popup-dark-input-bg);
            --popup-input-border: var(--popup-dark-input-border);
            --popup-focus-shadow: var(--popup-dark-focus-shadow);
            --popup-hover-bg: var(--popup-dark-hover-bg);
            --popup-item-hover: var(--popup-dark-item-hover);
            --popup-hdr-bg: #2c3e50; /* Darker header for dark mode */
            --popup-hdr-text: #e9ecef;
            --popup-strength-bg-color: var(--popup-dark-strength-bg);
            --popup-strength-border-color: var(--popup-dark-strength-border);
        }

        body {
            width: 370px; /* Adjusted width */
            padding: 0;
            margin: 0;
            font-family: var(--popup-font);
            font-size: 14px;
            background-color: var(--popup-bg);
            color: var(--popup-text);
            transition: background-color var(--popup-transition), color var(--popup-transition);
        }
        .container { display: flex; flex-direction: column; max-height: 550px; /* Limit total popup height */ }

        /* Header */
        .popup-header {
            background-color: var(--popup-hdr-bg);
            color: var(--popup-hdr-text);
            padding: 10px 15px; /* Slightly less padding */
            display: flex; justify-content: space-between; align-items: center;
            transition: background-color var(--popup-transition), color var(--popup-transition);
        }
        .popup-header h2 { font-size: 1.05em; margin: 0; font-weight: 500; }
        .popup-header button#logout-btn,
        .popup-header button#popup-theme-toggle {
            background-color: rgba(255, 255, 255, 0.15); color: var(--popup-hdr-text); border: 1px solid rgba(255, 255, 255, 0.3); padding: 4px 8px; font-size: 0.8em; border-radius: var(--popup-border-radius); cursor: pointer; transition: background-color var(--popup-transition); line-height: 1;
        }
        .popup-header button#logout-btn:hover,
        .popup-header button#popup-theme-toggle:hover { background-color: rgba(255, 255, 255, 0.25); }
        body[data-theme="dark"] .popup-header button#logout-btn,
        body[data-theme="dark"] .popup-header button#popup-theme-toggle {
            background-color: rgba(0, 0, 0, 0.2); border-color: rgba(255, 255, 255, 0.2);
        }
        body[data-theme="dark"] .popup-header button#logout-btn:hover,
        body[data-theme="dark"] .popup-header button#popup-theme-toggle:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }
        #theme-toggle-container { /* Container for the theme toggle */
             margin-left: auto; /* Push it right */
             padding-left: 10px;
        }

        /* Content Area */
        .content-area { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }

        /* Login View */
        #login-view .content-area { background-color: var(--popup-card-bg); border-radius: 0 0 var(--popup-border-radius) var(--popup-border-radius); box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 20px;}
        #login-view label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--popup-text-secondary); font-size: 0.9em; }
        #login-view input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid var(--popup-input-border); border-radius: var(--popup-border-radius); box-sizing: border-box; background-color: var(--popup-input-bg); color: var(--popup-text); transition: border-color var(--popup-transition), box-shadow var(--popup-transition); }
        #login-view input:focus { border-color: var(--popup-primary-color); outline: none; box-shadow: 0 0 0 2px var(--popup-focus-shadow); }
        #login-view button { width: 100%; padding: 10px; background-image: linear-gradient(135deg, var(--popup-primary-color), var(--popup-primary-darker)); color: white; border: none; border-radius: var(--popup-border-radius); font-size: 1em; cursor: pointer; transition: all var(--popup-transition); margin-top: 10px; background-size: 200% auto; }
        #login-view button:hover { background-position: right center; box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2); }
        #login-view button:active { transform: translateY(1px); }


        /* Main View */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 5px; /* Add padding */
        }
        #current-domain {
            font-size: 0.85em;
            color: var(--popup-text-secondary);
            font-style: italic;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 220px; /* Adjust as needed */
        }
        #search-input { width: 100%; padding: 9px 12px; border: 1px solid var(--popup-input-border); border-radius: var(--popup-border-radius); box-sizing: border-box; font-size: 0.95em; margin-bottom: 10px; background-color: var(--popup-input-bg); color: var(--popup-text); transition: all var(--popup-transition); }
        #search-input:focus { border-color: var(--popup-primary-color); outline: none; box-shadow: 0 0 0 2px var(--popup-focus-shadow); }

        .password-list-container { flex-grow: 1; max-height: 220px; /* Max height for scroll */ overflow-y: auto; border: 1px solid var(--popup-border); border-radius: var(--popup-border-radius); background-color: var(--popup-card-bg); margin-bottom: 10px; transition: all var(--popup-transition); }
        .password-list { list-style: none; padding: 0; margin: 0; }
        .password-item { padding: 10px 12px; border-bottom: 1px solid var(--popup-border); display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; transition: background-color 0.15s ease; }
        .password-item:last-child { border-bottom: none; }
        .password-item:hover { background-color: var(--popup-item-hover); }
        .password-item > div:first-child { flex-grow: 1; overflow: hidden; }
        .item-info { display: flex; flex-direction: column; line-height: 1.4; }
        .item-info strong { font-weight: 600; color: var(--popup-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .item-info span { color: var(--popup-text-secondary); font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .item-actions {
            flex-shrink: 0;
            display: flex;
            gap: 5px; /* Adjust gap */
            align-items: center; /* Vertically align buttons */
        }
        .item-actions button {
            font-size: 0.8em;
            padding: 4px 6px; /* Adjust padding */
            background-color: var(--popup-hover-bg);
            color: var(--popup-text-secondary);
            border: 1px solid var(--popup-border);
            border-radius: var(--popup-border-radius);
            cursor: pointer;
            transition: all var(--popup-transition);
        }
        .item-actions button:hover { background-color: #d3d9df; color: var(--popup-text); border-color: var(--popup-secondary-color); }
        body[data-theme="dark"] .item-actions button:hover { background-color: #5a6268; }


        /* Add Form */
        .add-form { border: 1px solid var(--popup-border); padding: 15px; border-radius: var(--popup-border-radius); background-color: var(--popup-card-bg); margin-top: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all var(--popup-transition); }
        .add-form h3 { font-size: 1.05em; margin: 0 0 15px 0; text-align: center; color: var(--popup-text-secondary); font-weight: 500; }
        .add-form label { margin-bottom: 4px; font-size: 0.9em; font-weight: 500; display: block; color: var(--popup-text-secondary); }
        .add-form input[type="text"], .add-form input[type="password"] { width: 100%; padding: 9px; margin-bottom: 10px; font-size: 0.95em; border: 1px solid var(--popup-input-border); border-radius: var(--popup-border-radius); box-sizing: border-box; background-color: var(--popup-input-bg); color: var(--popup-text); transition: all var(--popup-transition); }
         .add-form input[type="range"] { width: 100%; padding: 0; height: 18px; margin-bottom: 5px; accent-color: var(--popup-primary-color); }
         .add-form input:focus { border-color: var(--popup-primary-color); outline: none; box-shadow: 0 0 0 2px var(--popup-focus-shadow); }
        .add-form .form-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .add-form .form-buttons button { flex-grow: 1; padding: 9px; }

        /* Buttons within Add Form */
        .btn { border: none; border-radius: var(--popup-border-radius); cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all var(--popup-transition); }
        .label-button-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .label-button-group label { margin-bottom: 0; }
        .label-button-group button { padding: 2px 6px; font-size: 0.8em; }
        .btn-primary { background-image: linear-gradient(135deg, var(--popup-primary-color), var(--popup-primary-darker)); color: white; background-size: 200% auto; }
        .btn-primary:hover { background-position: right center; box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2); }
        .btn-secondary { background-image: linear-gradient(135deg, var(--popup-secondary-color), var(--popup-secondary-darker)); color: white; background-size: 200% auto; }
        .btn-secondary:hover { background-position: right center; box-shadow: 0 2px 5px rgba(108, 117, 125, 0.2); }
        .btn-outline-secondary { background-color: transparent; border: 1px solid var(--popup-secondary-color); color: var(--popup-secondary-color); }
        .btn-outline-secondary:hover { background-color: var(--popup-secondary-color); color: white; }
        .btn-add-toggle { width: 100%; padding: 10px; margin-top: 5px; background-image: linear-gradient(135deg, var(--popup-success-color), var(--popup-success-darker)); color: white; background-size: 200% auto; }
        .btn-add-toggle:hover { background-position: right center; box-shadow: 0 2px 5px rgba(40, 167, 69, 0.2); }


         /* Popup Generator Options Styles */
        .popup-generator-options { border-top: 1px solid var(--popup-border); margin-top: 15px; padding-top: 15px; }
        .popup-generator-options h4 { margin: 0 0 10px 0; font-size: 0.95em; color: var(--popup-text-secondary); font-weight: 500; }
        .popup-length-control { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .popup-length-control label { margin-bottom: 0; font-size: 0.85em; }
        .popup-length-control input[type="range"] { flex-grow: 1; margin-bottom: 0; }
        .popup-length-display { font-weight: 600; font-size: 0.9em; min-width: 20px; text-align: right; color: var(--popup-primary-color); }
        .popup-char-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .popup-option-group { display: flex; align-items: center; gap: 4px; }
        .popup-option-group label { margin-bottom: 0; font-weight: normal; font-size: 0.85em; color: var(--popup-text); cursor: pointer;}
        .popup-option-group input[type="checkbox"] { cursor: pointer; margin-top: 0px; width: 14px; height: 14px; padding: 0; margin-bottom: 0; accent-color: var(--popup-primary-color);}

        /* Popup Strength Display Styles */
        .popup-strength-area {
            margin-top: 8px; margin-bottom: 12px; padding: 8px; border-radius: var(--popup-border-radius); background-color: var(--popup-strength-bg-color); border: 1px solid var(--popup-strength-border-color); min-height: 45px; font-size: 0.9em;
            transition: all var(--popup-transition);
        }
        /* Scored Backgrounds (Light Theme) */
        .popup-strength-area.strength-0 { background-color: #f8d7da; border-color: #f5c6cb;}
        .popup-strength-area.strength-1 { background-color: #fff3cd; border-color: #ffeeba;}
        .popup-strength-area.strength-2 { background-color: #d1ecf1; border-color: #bee5eb;}
        .popup-strength-area.strength-3 { background-color: #d4edda; border-color: #c3e6cb;}
        .popup-strength-area.strength-4 { background-color: #c8e6c9; border-color: #a5d6a7;}
        /* Scored Backgrounds (Dark Theme) */
        body[data-theme="dark"] .popup-strength-area.strength-0 { background-color: #58151c; border-color: #842029;}
        body[data-theme="dark"] .popup-strength-area.strength-1 { background-color: #664d03; border-color: #997404;}
        body[data-theme="dark"] .popup-strength-area.strength-2 { background-color: #055160; border-color: #087990;}
        body[data-theme="dark"] .popup-strength-area.strength-3 { background-color: #0f5132; border-color: #146c43;}
        body[data-theme="dark"] .popup-strength-area.strength-4 { background-color: #1f6322; border-color: #28832c;}

        .popup-strength-meter-container { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .popup-strength-label { font-weight: 600; font-size: 0.9em; width: 85px; flex-shrink: 0; color: var(--popup-text-secondary); }
        .popup-strength-bar { height: 8px; background-color: var(--popup-hover-bg); border-radius: 4px; overflow: hidden; flex-grow: 1; transition: background-color var(--popup-transition); }
        .popup-strength-indicator { height: 100%; width: 0%; transition: width 0.4s ease, background-image 0.4s ease; border-radius: 4px; background-image: linear-gradient(to right, #e74c3c, #dc3545); /* Default gradient */ }
        /* Strength Colors - Use gradient */
        .popup-strength-indicator.very-weak { background-image: linear-gradient(to right, #dc3545, #c82333); width: 10%; }
        .popup-strength-indicator.weak { background-image: linear-gradient(to right, #fd7e14, #e67e22); width: 30%; }
        .popup-strength-indicator.medium { background-image: linear-gradient(to right, #ffc107, #dda600); width: 55%; }
        .popup-strength-indicator.strong { background-image: linear-gradient(to right, #20c997, #1aa07f); width: 80%; }
        .popup-strength-indicator.very-strong { background-image: linear-gradient(to right, #198754, #13653f); width: 100%; }

        #popup-strength-feedback { font-size: 0.85em; color: var(--popup-text-secondary); line-height: 1.3; transition: color var(--popup-transition); }
        #popup-strength-feedback ul { list-style: none; padding-left: 0; margin: 3px 0 0 0; }
        #popup-strength-feedback li { margin-bottom: 2px; padding-left: 12px; position: relative; }
        #popup-strength-feedback li::before { content: ''; position: absolute; left: 0; top: 6px; width: 5px; height: 5px; border-radius: 50%; background-color: currentColor; opacity: 0.7; }
        /* Light Theme Feedback */
        #popup-strength-feedback li.warning { color: #856404; font-weight: 500;}
        #popup-strength-feedback li.suggestion { color: #0c5460; }
        /* Dark Theme Feedback */
        body[data-theme="dark"] #popup-strength-feedback li.warning { color: var(--warning-color); }
        body[data-theme="dark"] #popup-strength-feedback li.suggestion { color: var(--info-color); }

        /* Style for strength in list items */
        .strength-display-popup {
             font-size: 0.8em; text-align: right; margin-top: 4px; padding-right: 5px; display: none; /* Hide initially */
             font-weight: 500;
             transition: color var(--popup-transition);
        }
         .strength-display-popup.score-0 { color: var(--popup-danger-color); }
         .strength-display-popup.score-1 { color: #fd7e14; }
         .strength-display-popup.score-2 { color: #ffc107; }
         .strength-display-popup.score-3 { color: #20c997; }
         .strength-display-popup.score-4 { color: var(--popup-success-color); }


        /* Status/Error Messages */
        .status-message { padding: 8px 10px; margin: 10px 0 5px 0; border-radius: var(--popup-border-radius); text-align: center; font-size: 0.9em; border: 1px solid transparent; transition: all var(--popup-transition); }
        .status-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;}
        body[data-theme="dark"] .status-error { background-color: #58151c; color: #f1aeb5; border-color: #842029; }
        body[data-theme="dark"] .status-success { background-color: #0f5132; color: #75b798; border-color: #146c43; }
        body[data-theme="dark"] .status-info { background-color: #055160; color: #6edff6; border-color: #087990;}

        .hidden { display: none !important; } /* Use important to ensure override */

        /* Scrollbar styling (optional, webkit only) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--popup-hover-bg); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--popup-secondary-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--popup-secondary-darker); }
    </style>
</head>
<body>
    <div class="container">

        <!-- Login View -->
        <div id="login-view">
             <div class="popup-header">
                 <h2>Secure Login</h2>
             </div>
            <div class="content-area">
                <div id="login-error" class="status-message status-error hidden"></div>
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email" required>
                <label for="masterPasswordLogin">Master Password:</label>
                <input type="password" id="masterPasswordLogin" placeholder="Enter Master Password" required>
                <button id="login-btn" class="btn btn-primary">Login</button> <!-- Applied general button style -->
            </div>
        </div>

        <!-- Main Logged-In View -->
        <div id="main-view" class="hidden">
             <div class="popup-header">
                 <h2>Credentials</h2>
                 <!-- Add Theme Toggle Button -->
                 <div id="theme-toggle-container">
                    <button id="popup-theme-toggle" title="Toggle light/dark theme">☀️</button>
                 </div>
                 <button id="logout-btn">Logout</button>
             </div>
             <div class="content-area">
                 <!-- Display Current Domain -->
                 <div class="main-header">
                    <span id="current-domain" title="Current Tab Domain">Domain: N/A</span>
                 </div>
                <input type="search" id="search-input" placeholder="Filter by service name...">
                <div id="status-indicator" class="status-message status-info hidden"></div>
                <div class="password-list-container">
                    <ul id="password-list">
                        <!-- List items are generated by popup.js -->
                        <!-- Example Structure (for reference):
                        <li class="password-item" data-encrypted="..." data-service-hint="...">
                            <div style="flex-grow: 1; overflow: hidden;">
                                <div class="item-info">
                                    <strong>Service Hint</strong>
                                    <span class="username-display">(Username Hidden)</span>
                                </div>
                                <div class="strength-display-popup score-x">Strength: ...</div>
                            </div>
                            <div class="item-actions">
                                <button>Show</button>
                                <button style="display: none;">Copy</button>
                                <button style="display: none;">Fill</button>
                            </div>
                        </li>
                        -->
                    </ul>
                </div>
                <button id="add-password-btn" class="btn btn-secondary btn-add-toggle">+ Add New Credential</button>

                <!-- Add/Edit Form -->
                <div id="add-password-form" class="add-form hidden">
                    <h3>Add New Credential</h3>
                    <div id="save-error" class="status-message status-error hidden"></div>
                    <label for="service">Service/Website:</label>
                    <input type="text" id="service" placeholder="e.g., Google, Example.com" required>
                    <label for="new-username">Username/Email:</label>
                    <input type="text" id="new-username" placeholder="Your username or email" required>

                    <div class="label-button-group">
                         <label for="new-password">Password:</label>
                         <button type="button" id="generate-popup-password-btn" class="btn btn-outline-secondary">Generate</button>
                    </div>
                    <input type="password" id="new-password" placeholder="Enter or generate password" required>

                    <!-- Popup Strength Display -->
                    <div id="popup-strength-area" class="popup-strength-area" style="display: none;"> <!-- Initially hidden -->
                        <div class="popup-strength-meter-container">
                             <span class="popup-strength-label" id="popup-strength-text-label">Strength:</span>
                             <div class="popup-strength-bar">
                                 <div id="popup-strength-indicator" class="popup-strength-indicator very-weak"></div> <!-- Default class -->
                             </div>
                        </div>
                        <div id="popup-strength-feedback"></div>
                    </div>
                    <!-- End Popup Strength Display -->

                    <!-- Generator Options -->
                    <div class="popup-generator-options">
                         <h4>Generator Options</h4>
                         <div class="popup-length-control"> <label for="popup-gen-length">Length:</label> <input type="range" id="popup-gen-length" name="popup-gen-length" min="8" max="64" value="16"> <span class="popup-length-display" id="popup-gen-length-value">16</span> </div>
                         <div class="popup-char-options">
                             <div class="popup-option-group"> <input type="checkbox" id="popup-gen-lowercase" checked> <label for="popup-gen-lowercase">a-z</label> </div>
                             <div class="popup-option-group"> <input type="checkbox" id="popup-gen-uppercase" checked> <label for="popup-gen-uppercase">A-Z</label> </div>
                             <div class="popup-option-group"> <input type="checkbox" id="popup-gen-digits" checked> <label for="popup-gen-digits">0-9</label> </div>
                             <div class="popup-option-group"> <input type="checkbox" id="popup-gen-symbols" checked> <label for="popup-gen-symbols">!@#</label> </div>
                         </div>
                     </div>

                    <label for="masterPasswordSave">Confirm Master Password:</label>
                    <input type="password" id="masterPasswordSave" placeholder="Enter Master Password to save" required>
                    <div class="form-buttons">
                        <button id="save-password-btn" class="btn btn-primary">Encrypt & Save</button>
                        <button type="button" id="cancel-add-btn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Include zxcvbn library FIRST -->
    <script src="zxcvbn.js"></script>
    <!-- Then other helpers and main popup script -->
    <script src="crypto-helpers.js"></script>
    <script src="popup.js"></script>
</body>
</html>