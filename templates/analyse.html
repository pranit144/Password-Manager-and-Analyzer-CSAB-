<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Passwords - Secure Password Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Reset and base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background-color: #f5f7fa; padding-bottom: 60px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { margin-bottom: 30px; }
        h1 { color: #2c3e50; margin-bottom: 20px; text-align: center; }
        .llm-badge { display: inline-block; background-color: #17a2b8; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; margin-left: 10px; vertical-align: middle; }

        /* Navigation */
        nav ul { display: flex; justify-content: center; list-style: none; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); overflow: hidden; padding: 0; }
        nav li { flex: 1; text-align: center; }
        nav a { display: block; padding: 15px 0; color: #555; text-decoration: none; transition: all 0.3s ease; font-weight: 500; border-bottom: 3px solid transparent; }
        nav a:hover { background-color: #f0f2f5; border-bottom-color: #ddd; }
        nav a.active { background-color: #e9f5ff; color: #0056b3; border-bottom-color: #007bff; }

        /* Logout Link */
        .logout-link { float: right; margin: -45px 10px 0 0; color: #007bff; text-decoration: none; font-weight: 500; }
        .logout-link:hover { text-decoration: underline; }

        /* Card styles */
        .card { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); padding: 30px; margin-bottom: 30px; }
        h2, h3 { color: #2c3e50; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h3 { margin-top: 25px; font-size: 1.3em; }
        p { color: #555; margin-bottom: 20px; }

        /* Form styles */
        .form-group { margin-bottom: 25px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        input[type="password"] { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; transition: border-color 0.3s ease; box-sizing: border-box; }
        input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .btn { background-color: #3498db; color: white; border: none; border-radius: 4px; padding: 12px 25px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s ease; font-weight: 500; }
        .btn:hover { background-color: #2980b9; }
        .btn:disabled { background-color: #a5c9e0; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; margin-top: 10px; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }

        /* Toggle button */
        .toggle-button { position: absolute; right: 10px; top: 40px; background: none; border: none; color: #3498db; cursor: pointer; font-size: 14px; padding: 5px; }

        /* Password analysis result styles */
        .analysis-result { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .strength-bar { height: 10px; background-color: #eee; border-radius: 5px; overflow: hidden; margin: 5px 0; display: inline-block; width: 100%; }
        .strength-indicator { height: 100%; width: 0%; transition: width 0.5s ease, background-color 0.5s ease; }
        .very-weak { background-color: #e74c3c; width: 20%; }
        .weak { background-color: #e67e22; width: 40%; }
        .medium { background-color: #f1c40f; width: 60%; }
        .strong { background-color: #2ecc71; width: 80%; }
        .very-strong { background-color: #27ae60; width: 100%; }
        .strength-text { font-weight: 600; }

        /* Feedback styles */
        .feedback-section { margin-top: 5px; } /* Reduced margin */
        .feedback-item { margin-bottom: 6px; padding: 6px 10px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid; line-height: 1.4; }
        .feedback-item.issue { background-color: #fff0f0; border-left-color: #e74c3c; color: #721c24; }
        .feedback-item.tip { background-color: #f0f8ff; border-left-color: #3498db; color: #0c5460; }

        /* Table styles for analysis results */
        .analysis-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; /* Helps with column widths */ }
        .analysis-table th, .analysis-table td { padding: 10px 12px; text-align: left; border: 1px solid #ddd; vertical-align: top; word-wrap: break-word; }
        .analysis-table th { background-color: #f9fafb; font-weight: 600; color: #555; white-space: nowrap; }
        .analysis-table tr:nth-child(even) { background-color: #fdfdfd; }
        .analysis-table tr:hover { background-color: #f1f1f1; }
        .analysis-table th:nth-child(1) { width: 20%; } /* Service */
        .analysis-table th:nth-child(2) { width: 20%; } /* Username */
        .analysis-table th:nth-child(3) { width: 15%; } /* Strength */
        .analysis-table th:nth-child(4) { width: 15%; } /* Assessment */
        .analysis-table th:nth-child(5) { width: 30%; } /* Feedback */

        /* Loading spinner */
        .loading-indicator { display: none; text-align: center; margin: 20px 0; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3498db; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-indicator p { margin-top: 10px; color: #555; }
        .status-message { text-align: center; padding: 15px; color: #555; font-style: italic; }


        /* Footer */
        footer { text-align: center; padding: 20px 0; margin-top: 30px; color: #777; font-size: 14px; border-top: 1px solid #eee; }

        /* Responsive */
        @media (max-width: 768px) {
             nav ul { flex-direction: column; }
             nav a { border-bottom: 1px solid #eee; }
             nav a.active { border-bottom-color: #007bff; }
             .logout-link { float: none; text-align: center; margin: 10px 0; display: block; }
            .toggle-button { top: 38px; }
            .analysis-table { display: block; overflow-x: auto; white-space: nowrap; }
            .analysis-table th, .analysis-table td { white-space: normal; } /* Allow wrapping */
            .analysis-table th:nth-child(n), .analysis-table td:nth-child(n) { width: auto; } /* Reset fixed widths */
            .analysis-table td:last-child { min-width: 200px; } /* Give feedback some space */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Password Analysis <span class="llm-badge">AI Insights</span></h1>
             {% if current_user.is_authenticated %}
                 <a href="{{ url_for('logout') }}" class="logout-link">Logout ({{ current_user.email }})</a>
             {% endif %}
            <nav>
                <ul>
                    <li><a href="{{ url_for('add_password_page') }}">Add Password</a></li>
                    <li><a href="{{ url_for('storage') }}">View Passwords</a></li>
                    <li><a href="{{ url_for('analyse') }}" class="active">Analyse Passwords</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <!-- Single Password Analysis Card -->
            <section class="card">
                <h2>Analyse a Single Password</h2>
                <p>Enter a password below to get an instant strength analysis using AI insights. The password itself is not stored or sent after analysis.</p>
                <form id="analyse-form">
                    <div class="form-group">
                        <label for="analyse-password">Password to Analyse:</label>
                        <input type="password" id="analyse-password" name="analyse-password" required autocomplete="new-password">
                        <button type="button" id="toggle-analyse-password" class="toggle-button" title="Show/hide password">Show</button>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">Analyse Password</button>
                    </div>
                </form>

                <div id="single-loading" class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Analysing...</p>
                </div>

                <div id="single-analysis-result" class="analysis-result" style="display: none;">
                    <h3>Analysis Result</h3>
                    <table class="analysis-table"> <!-- Use consistent class -->
                        <thead>
                            <tr>
                                <th>Password</th>
                                <th>Strength Bar</th>
                                <th>Assessment</th>
                                <th>AI Insights & Suggestions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="password-value">*****</td>
                                <td>
                                    <div class="strength-bar">
                                        <div id="strength-indicator" class="strength-indicator"></div>
                                    </div>
                                </td>
                                <td id="strength-text">Medium</td>
                                <td id="feedback-cell">
                                    <div id="feedback-list">
                                        <!-- Feedback items populated by JS -->
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Stored Passwords Analysis Card -->
            <section class="card">
                <h2>Analyse All Stored Credentials</h2>
                <p>Decrypt and analyse all your stored credentials to identify potential weaknesses across your accounts. This may take some time depending on the number of credentials.</p>
                <button id="analyse-all-btn" class="btn btn-secondary">Load & Analyse All Stored Credentials</button>

                <div id="all-passwords-loading" class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Loading, decrypting, and analysing all credentials...</p>
                </div>
                 <div id="all-analysis-status" class="status-message"></div>

                <div id="all-passwords-analysis" style="display: none; margin-top: 20px;">
                     <h3>Stored Credentials Analysis</h3>
                    <div style="overflow-x: auto;"> <!-- Ensure table is scrollable if needed -->
                        <table class="analysis-table" id="password-analysis-table">
                            <thead>
                                <tr>
                                    <th>Service/Website</th>
                                    <th>Username/Email</th>
                                    <th>Strength</th>
                                    <th>Assessment</th>
                                    <th>AI Insights & Suggestions</th>
                                </tr>
                            </thead>
                            <tbody id="password-analysis-list">
                                <!-- Analysis entries populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Secure Password Manager - E2EE Demo</p>
        </footer>
    </div>

    <script>
        // --- E2EE Helper Functions ---
        function base64UrlDecode(b64url) {
             let b64 = b64url.replace(/-/g, '+').replace(/_/g, '/'); while (b64.length % 4) b64 += '='; return base64ToArrayBuffer(b64);
        }
        async function getEncryptionKeyRawBytes() {
            const keyB64Url = sessionStorage.getItem('encryptionKey');
            if (!keyB64Url) { console.error("Key missing"); alert("Key missing. Login again."); window.location.href="{{ url_for('login')}}"; return null; }
            try { return base64UrlDecode(keyB64Url); } catch (e) { console.error("Key decode failed:", e); alert("Invalid key. Login again."); window.location.href="{{ url_for('login')}}"; return null; }
        }
        async function decryptData(keyBuffer, encryptedB64Data) {
             try {
                 const combinedData = base64ToArrayBuffer(encryptedB64Data); if (combinedData.byteLength < 12) throw new Error("Data too short.");
                 const iv = combinedData.slice(0, 12); const ciphertext = combinedData.slice(12);
                 const cryptoKey = await crypto.subtle.importKey("raw", keyBuffer, { name: "AES-GCM", length: 256 }, false, ["decrypt"]);
                 const decryptedContent = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, cryptoKey, ciphertext);
                 return JSON.parse(new TextDecoder().decode(decryptedContent));
             } catch (error) { console.error("Decryption error:", error); return null; }
        }
        function base64ToArrayBuffer(base64) {
             try { const s=window.atob(base64), l=s.length, b=new Uint8Array(l); for(let i=0;i<l;i++) b[i]=s.charCodeAt(i); return b.buffer; }
             catch(e) { console.error("B64 decode error:",e); throw new Error("Invalid Base64"); }
        }
        function arrayBufferToBase64(buffer) {
             let bin=''; const bytes=new Uint8Array(buffer); const len=bytes.byteLength; for(let i=0;i<len;i++) bin+=String.fromCharCode(bytes[i]); return window.btoa(bin);
        }
        function escapeHtml(unsafe) {
             return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
        }

        // --- Client-Side Password Analysis Helpers ---
        function getPasswordCharacteristics(password) {
            let comp = { lowercase: 0, uppercase: 0, digits: 0, special: 0 };
            if (!password || typeof password !== 'string') return { length: 0, composition: comp };
            for (let i = 0; i < password.length; i++) {
                const char = password[i];
                if (char >= 'a' && char <= 'z') comp.lowercase++; else if (char >= 'A' && char <= 'Z') comp.uppercase++;
                else if (char >= '0' && char <= '9') comp.digits++; else if (!char.match(/^[a-zA-Z0-9\s]$/)) comp.special++;
            } return { length: password.length, composition: comp };
        }
         function getStrengthClass(score) {
             if (score <= 1) return 'very-weak'; if (score === 2) return 'weak'; if (score === 3) return 'medium';
             if (score === 4) return 'strong'; return 'very-strong';
         }
         function formatFeedbackHtml(feedbackArray) {
            if (!feedbackArray || feedbackArray.length === 0) return '<div class="feedback-item tip">No specific issues found.</div>';
            let html = '<div class="feedback-section">';
            feedbackArray.forEach(fb => {
                let itemClass = 'feedback-item'; let text = fb;
                if (fb.startsWith('Issue:')) { itemClass += ' issue'; text = fb.substring(6).trim(); }
                else if (fb.startsWith('Tip:')) { itemClass += ' tip'; text = fb.substring(4).trim(); }
                else { itemClass += ' issue'; } // Default to issue style
                 html += `<div class="${itemClass}">${escapeHtml(text)}</div>`;
            }); html += '</div>'; return html;
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
             const flaskKey = "{{ session.get('encryption_key', 'null') }}";
              if (flaskKey !== 'null' && !sessionStorage.getItem('encryptionKey')) sessionStorage.setItem('encryptionKey', flaskKey);
              else if (!sessionStorage.getItem('encryptionKey')) { console.warn("Key missing, redirecting."); window.location.href = "{{ url_for('login') }}"; return; }

            // Single Analysis Elements
            const analyseForm = document.getElementById('analyse-form');
            const togglePasswordBtn = document.getElementById('toggle-analyse-password');
            const passwordInput = document.getElementById('analyse-password');
            const singleAnalysisResultEl = document.getElementById('single-analysis-result');
            const singleLoadingEl = document.getElementById('single-loading');
            const strengthIndicator = document.getElementById('strength-indicator');
            const strengthText = document.getElementById('strength-text');
            const feedbackList = document.getElementById('feedback-list');
            const passwordValueCell = document.getElementById('password-value');
            const singleSubmitBtn = analyseForm.querySelector('button[type="submit"]');

            // All Analysis Elements
            const analyseAllBtn = document.getElementById('analyse-all-btn');
            const allPasswordsLoadingEl = document.getElementById('all-passwords-loading');
            const allPasswordsAnalysisEl = document.getElementById('all-passwords-analysis');
            const passwordAnalysisListBody = document.getElementById('password-analysis-list');
            const allAnalysisStatus = document.getElementById('all-analysis-status');

            // --- Single Analysis Logic ---
            togglePasswordBtn.addEventListener('click', function() {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type; this.textContent = type === 'password' ? 'Show' : 'Hide';
            });
            analyseForm.addEventListener('submit', async function(e) {
                e.preventDefault(); const password = passwordInput.value; if (!password) return;
                singleLoadingEl.style.display = 'block'; singleAnalysisResultEl.style.display = 'none';
                singleSubmitBtn.disabled = true; passwordValueCell.textContent = password.replace(/./g, '*');
                try {
                    const characteristics = getPasswordCharacteristics(password);
                    const response = await fetch("{{ url_for('analyse_password_api') }}", {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ characteristics: characteristics })
                    });
                    if (!response.ok) { const err = await response.json().catch(() => ({})); throw new Error(`Analysis failed: ${response.status} ${err.error || ''}`); }
                    const analysisResult = await response.json();
                    updateSingleAnalysisUI(analysisResult);
                } catch (error) {
                    console.error('Single analysis error:', error); alert(`Error: ${error.message}`);
                    singleAnalysisResultEl.style.display = 'block'; feedbackList.innerHTML = `<div class="feedback-item issue">Failed: ${escapeHtml(error.message)}</div>`;
                    strengthIndicator.style.width = '0%'; strengthText.textContent = 'Error';
                } finally { singleLoadingEl.style.display = 'none'; singleSubmitBtn.disabled = false; }
            });
             function updateSingleAnalysisUI(data) {
                 singleAnalysisResultEl.style.display = 'block'; const score = data.strength || 1;
                 strengthIndicator.style.width = (score / 5) * 100 + '%';
                 strengthIndicator.className = 'strength-indicator ' + getStrengthClass(score);
                 strengthText.textContent = data.assessment || 'Unknown';
                 const feedbackCellContent = feedbackList; // Directly target the div
                  if (feedbackCellContent) feedbackCellContent.innerHTML = formatFeedbackHtml(data.feedback);
             }

            // --- All Analysis Logic ---
            analyseAllBtn.addEventListener('click', async function() {
                allPasswordsLoadingEl.style.display = 'block'; allPasswordsAnalysisEl.style.display = 'none';
                passwordAnalysisListBody.innerHTML = ''; allAnalysisStatus.textContent = ''; allAnalysisStatus.style.color = '';
                analyseAllBtn.disabled = true;
                try {
                    const encryptionKey = await getEncryptionKeyRawBytes(); if (!encryptionKey) throw new Error("Key missing. Login again.");
                    allAnalysisStatus.textContent = 'Fetching credentials...';
                    const credResponse = await fetch("{{ url_for('get_credentials') }}");
                    if (!credResponse.ok) throw new Error('Failed to fetch credentials');
                    const encryptedCredentials = await credResponse.json();
                    if (!encryptedCredentials || encryptedCredentials.length === 0) {
                        allAnalysisStatus.textContent = 'No stored credentials found.'; allPasswordsLoadingEl.style.display = 'none'; analyseAllBtn.disabled = false; return;
                    }
                    allAnalysisStatus.textContent = `Found ${encryptedCredentials.length}. Analysing...`;
                    let analysedCount = 0; const totalCount = encryptedCredentials.length; const results = [];
                    allPasswordsAnalysisEl.style.display = 'block'; // Show table header

                    for (const cred of encryptedCredentials) {
                        const decrypted = await decryptData(encryptionKey, cred.encrypted_data);
                        let analysisResult = { strength: 0, assessment: 'Error', feedback: ['Issue: Processing Error'] }; // Default error state
                        let serviceName = cred.service_hint || `(Hint: ${cred.id.substring(0,8)})`;
                        let userName = '(Unknown)';

                        if (decrypted) {
                            serviceName = decrypted.service || serviceName; // Prefer decrypted name
                            userName = decrypted.username || userName;
                            if (decrypted.password) {
                                const characteristics = getPasswordCharacteristics(decrypted.password);
                                try {
                                    const apiResp = await fetch("{{ url_for('analyse_password_api') }}", {
                                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ characteristics: characteristics })
                                    });
                                    if (apiResp.ok) analysisResult = await apiResp.json();
                                    else { analysisResult.assessment = 'API Error'; analysisResult.feedback = ['Issue: Analysis service failed.']; }
                                } catch (apiError) { analysisResult.assessment = 'API Error'; analysisResult.feedback = [`Issue: ${apiError.message}`]; }
                            } else { analysisResult.assessment = 'No Password'; analysisResult.feedback = ['Issue: No password found in decrypted data.']; }
                        } else { analysisResult.assessment = 'Decrypt Error'; analysisResult.feedback = ['Issue: Could not decrypt data.']; userName = '(Decryption Failed)'; }

                        results.push({ service: serviceName, username: userName, ...analysisResult });
                        analysedCount++;
                        allAnalysisStatus.textContent = `Analysed ${analysedCount} of ${totalCount}...`;
                        // Optional small delay
                        // await new Promise(resolve => setTimeout(resolve, 10));
                    } // End loop
                    displayAllAnalysisResults(results);
                    allAnalysisStatus.textContent = `Analysis complete for ${results.length}.`;
                } catch (error) {
                    console.error('All analysis error:', error); allAnalysisStatus.textContent = `Error: ${error.message}`; allAnalysisStatus.style.color = 'red';
                } finally { allPasswordsLoadingEl.style.display = 'none'; analyseAllBtn.disabled = false; }
            });

             function displayAllAnalysisResults(results) {
                passwordAnalysisListBody.innerHTML = ''; allPasswordsAnalysisEl.style.display = 'block';
                if (results.length === 0) { passwordAnalysisListBody.innerHTML = '<tr><td colspan="5">No results.</td></tr>'; return; }
                 results.forEach((item) => {
                     const row = passwordAnalysisListBody.insertRow(); const score = item.strength || 0;
                     const strengthClass = getStrengthClass(score); const feedbackHtml = formatFeedbackHtml(item.feedback);
                     row.innerHTML = `
                        <td>${escapeHtml(item.service)}</td><td>${escapeHtml(item.username)}</td>
                        <td><div class="strength-bar" title="Strength: ${score}/5"><div class="strength-indicator ${strengthClass}" style="width: ${(score/5)*100}%"></div></div></td>
                        <td>${escapeHtml(item.assessment || 'N/A')}</td><td>${feedbackHtml}</td>
                    `;
                 });
             }
        }); // End DOMContentLoaded
    </script>
</body>
</html>